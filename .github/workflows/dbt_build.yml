name: dbt build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      # absolute paths (robusto)
      DBT_PROJECT_DIR: ${{ github.workspace }}/dbt/dbt_interrep
      DBT_PROFILES_DIR: ${{ github.workspace }}/.github/dbt
      DBT_TARGET: prod

      PGHOST: ${{ secrets.PGHOST }}
      PGPORT: ${{ secrets.PGPORT }}
      PGUSER: ${{ secrets.PGUSER }}
      PGPASSWORD: ${{ secrets.PGPASSWORD }}
      PGDATABASE: ${{ secrets.PGDATABASE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug repo tree
        run: |
          pwd
          ls -la
          ls -la dbt || true
          ls -la dbt/dbt_interrep || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dbt (Postgres adapter)
        run: |
          python -m pip install --upgrade pip
          pip install dbt-postgres
          dbt --version

      - name: Create profiles.yml
        run: |
          mkdir -p "${DBT_PROFILES_DIR}"
          cat > "${DBT_PROFILES_DIR}/profiles.yml" << 'YAML'
          dbt_interrep:
            target: prod
            outputs:
              prod:
                type: postgres
                host: "{{ env_var('PGHOST') }}"
                port: "{{ env_var('PGPORT') | int }}"
                user: "{{ env_var('PGUSER') }}"
                password: "{{ env_var('PGPASSWORD') }}"
                dbname: "{{ env_var('PGDATABASE') }}"
                schema: dbt
                threads: 4
          YAML

      - name: dbt deps
        run: dbt deps --project-dir "${DBT_PROJECT_DIR}" --profiles-dir "${DBT_PROFILES_DIR}"

      - name: dbt build
        run: dbt build --project-dir "${DBT_PROJECT_DIR}" --profiles-dir "${DBT_PROFILES_DIR}" --target "${DBT_TARGET}"
